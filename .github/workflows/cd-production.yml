name: CD Production

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: cd-production
  cancel-in-progress: false

jobs:
  # Backend + Frontend CI chạy song song (có cache nên rất nhanh)
  ci-backend:
    uses: ./.github/workflows/ci-backend.yml

  ci-frontend:
    uses: ./.github/workflows/ci-frontend.yml

  deploy-production:
    needs: [ci-backend, ci-frontend]
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: deploy/backend

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: deploy/frontend

      - name: Package artifacts for transfer
        run: tar -czf deploy-package.tar.gz -C deploy .

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PRODUCTION_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.PRODUCTION_PORT }} ${{ secrets.PRODUCTION_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Upload & Deploy to VPS
        env:
          SSH_HOST: ${{ secrets.PRODUCTION_HOST }}
          SSH_USER: ${{ secrets.PRODUCTION_USER }}
          SSH_PORT: ${{ secrets.PRODUCTION_PORT }}
        run: |
          SSH_CMD="ssh -i ~/.ssh/deploy_key -p ${SSH_PORT:-22} -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST}"
          SCP_CMD="scp -i ~/.ssh/deploy_key -P ${SSH_PORT:-22} -o StrictHostKeyChecking=no"

          echo "=== Production Deploy ==="
          echo "Commit: ${{ github.sha }}"
          echo "Time: $(date -u +%Y-%m-%dT%H:%M:%SZ)"

          # Tạo thư mục staging trên VPS
          $SSH_CMD "rm -rf /tmp/airline-deploy && mkdir -p /tmp/airline-deploy"

          # Upload gói deploy (1 file tar duy nhất, nhanh hơn nhiều file)
          $SCP_CMD deploy-package.tar.gz ${SSH_USER}@${SSH_HOST}:/tmp/airline-deploy/

          # Giải nén và chạy deploy script
          $SSH_CMD "cd /tmp/airline-deploy && tar -xzf deploy-package.tar.gz && /opt/airline/deploy-production.sh"

          echo "Production deploy completed successfully"

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key
