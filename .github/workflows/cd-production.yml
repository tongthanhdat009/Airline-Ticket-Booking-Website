name: CD Production

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: cd-production
  cancel-in-progress: false

jobs:
  # Backend + Frontend CI chạy song song (có cache nên rất nhanh)
  ci-backend:
    uses: ./.github/workflows/ci-backend.yml

  ci-frontend:
    uses: ./.github/workflows/ci-frontend.yml

  deploy-production:
    needs: [ci-backend, ci-frontend]
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: artifacts/backend

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: artifacts/frontend

      # Đổi tên JAR thành app.jar để deploy script không cần quan tâm tên phiên bản
      - name: Rename JAR to app.jar
        run: mv artifacts/backend/*.jar artifacts/backend/app.jar

      # Đóng gói frontend thành 1 file tar để SCP 1 lần duy nhất (nhanh hơn upload nhiều file)
      - name: Package frontend dist
        run: tar -czf artifacts/frontend-dist.tar.gz -C artifacts/frontend .

      # Upload JAR trực tiếp vào thư mục backend trên VPS
      # strip_components: 2 → bỏ prefix "artifacts/backend/" → file nằm ngay trong target dir
      - name: Upload JAR to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          port: ${{ secrets.PRODUCTION_PORT }}
          source: "artifacts/backend/app.jar"
          target: "/opt/airline-prod/backend/"
          strip_components: 2

      # Upload frontend tar vào /tmp để deploy script giải nén
      - name: Upload frontend dist to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          port: ${{ secrets.PRODUCTION_PORT }}
          source: "artifacts/frontend-dist.tar.gz"
          target: "/tmp/"
          strip_components: 2

      # SSH vào VPS: giải nén frontend rồi restart backend
      - name: Restart services via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          port: ${{ secrets.PRODUCTION_PORT }}
          script_stop: true
          script: |
            echo "=== Production Deploy ==="
            echo "Commit: ${{ github.sha }}"
            echo "Time: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            /opt/airline/deploy-production.sh
            echo "Deploy completed successfully"
